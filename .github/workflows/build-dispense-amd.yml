name: Build and Test Dispense
on:
  workflow_call: 

env:
  ACTIONS_STEP_DEBUG: true
  _BRANCH_NAME: ${{ github.ref_name }}
  IMAGE_NAME: gcr.io/fulfil-web/cv-dispense
  NPM_GITHUB_TOKEN: ${{ secrets.NPM_GITHUB_TOKEN }}

jobs:
  build_and_test:
    name: Build And Test Dispense
    runs-on: ubuntu-latest
    steps:
      - name: Tweak ENV
        run: |
          CLEAN_BRANCH_NAME=${_BRANCH_NAME//\//_}
          echo "CLEAN_BRANCH_NAME: $CLEAN_BRANCH_NAME"
          echo "BRANCH_NAME=$CLEAN_BRANCH_NAME" >> $GITHUB_ENV
          echo BRANCH_NAME: ${BRANCH_NAME}, IMAGE_NAME: ${IMAGE_NAME}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space (safe removals)
        run: |
          docker system prune -af || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo rm -rf /opt/google/chrome || true
          sudo apt-get clean
          df -h

      - uses: docker/setup-buildx-action@v3

      - name: Login to GCP Registry (Production)
        uses: Fulfil0518/gcp-registry-login-action@v1
        with:
          endpoint: ${{ env.IMAGE_NAME }}
          service_key: ${{ secrets.CLOUD_PROD_SA }}

      - uses: docker/build-push-action@v5
        name: Build image (load locally)
        with:
          context: .
          file: Dispense.amd.Dockerfile
          load: true
          tags: local/app:ci
          cache-from: type=gha,ref=${{ env.BRANCH_NAME }}:latest,ref=main:latest
          cache-to: type=gha,mode=max
          build-args: |
            NPM_GITHUB_TOKEN=${{ env.NPM_GITHUB_TOKEN }}

      - name: Run tests with docker compose
        run: |
          TEST_IMAGE=local/app:ci docker compose -f .github/compose/tests-ci.yml up \
            --abort-on-container-exit \
            --exit-code-from tests \
            tests

      - name: Tag and Push pre-built image to Registry
        if: success()
        run: |
          FINAL_TAG1=${{ env.IMAGE_NAME }}/${{ env.BRANCH_NAME }}:latest
          FINAL_TAG2=${{ env.IMAGE_NAME }}/${{ env.BRANCH_NAME }}:${{ github.sha }}
          docker tag local/app:ci "$FINAL_TAG1"
          docker tag local/app:ci "$FINAL_TAG2"
          docker push "$FINAL_TAG1"
          docker push "$FINAL_TAG2"

