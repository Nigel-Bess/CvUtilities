services:
  fulfil_dc_api:
    image: fulfil_dc_api
    platform: linux/amd64
    # Once we get this working, we can remove this command and just use the app command in the CMD
    command: /bin/bash -c "while true; do sleep 30; done;"
    profiles:
      - noop

  # Dispense commands
  dispense_eval:
    build:
      dockerfile: Dispense.amd.Dockerfile
    command: "Fulfil.Dispense/app/eval fed all"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./data:/home/fulfil/data"
      - "./Fulfil.Dispense/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.Dispense/data"
      - "./Fulfil.Dispense/configs:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.Dispense/configs"
    env_file:
      - path: .env
        required: false
    profiles:
      - dispense_test
      - fed_test

  # TCS commands
  tcs_test:
    build:
      dockerfile: TCS.Dockerfile
    command: "Fulfil.TCS/build/unit_test"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.TCS/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.TCS/data"
    env_file:
      - path: .env
        required: false
    profiles:
      - tcs_test

  # PBL commands
  pbl:
    build:
      dockerfile: TCS.Dockerfile
    command: "Fulfil.TCS/build/pbl"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.TCS/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.TCS/data"
    environment:
      - "FACILITY_IDENTIFIER=local"
      - "CAMERAS=0:0000000000001"
    env_file:
      - path: .env
        required: false
    profiles:
      - pbl

  # Repack commands
  repack_test:
    build:
      dockerfile: AlliedVision.Dockerfile
    command: "Fulfil.AlliedVision/build/test test ${REQ_ID}"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.AlliedVision/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.AlliedVision/data"
    env_file:
      - path: .env
        required: false
    profiles:
      - repack_test

  repack_download:
    build:
      dockerfile: AlliedVision.Dockerfile
    command: "python3 Fulfil.AlliedVision/scripts/repack_download_dataset.py"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.AlliedVision/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.AlliedVision/data"
    env_file:
      - path: .env
        required: false
    profiles:
      - repack_download

  repack_load_coco:
    build:
      dockerfile: AlliedVision.Dockerfile
    command: "python3 Fulfil.AlliedVision/scripts/coco/repack_generate_coco.py"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.AlliedVision/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.AlliedVision/data"
    network_mode: "host"
    env_file:
      - path: .env
        required: false
    profiles:
      - repack_load_coco

  repack_summarize:
    build:
      dockerfile: AlliedVision.Dockerfile
    command: "python3 Fulfil.AlliedVision/scripts/coco/repack_summarize.py"
    working_dir: /home/fulfil/code/Fulfil.ComputerVision
    volumes:
      - "./Fulfil.AlliedVision/data:/home/fulfil/code/Fulfil.ComputerVision/Fulfil.AlliedVision/data"
    network_mode: "host"
    env_file:
      - path: .env
        required: false
    profiles:
      - repack_summarize
